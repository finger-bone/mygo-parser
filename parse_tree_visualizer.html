<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§£ææ ‘å¯è§†åŒ–</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 0 auto;
            max-width: 1200px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        .node {
            cursor: pointer;
        }
        .node circle {
            stroke-width: 1.5px;
        }
        .node text {
            font: 10px sans-serif;
            pointer-events: none; /* é˜²æ­¢æ–‡æœ¬å¹²æ‰°é¼ æ ‡äº‹ä»¶ */
            text-shadow: 0 1px 0 #fff, 0 -1px 0 #fff, 1px 0 0 #fff, -1px 0 0 #fff; /* æ–‡æœ¬è½®å»“ï¼Œæé«˜å¯è¯»æ€§ */
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .link {
            fill: none;
            stroke: #ccc;
            stroke-width: 1.5px;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #45a049;
        }
        .legend {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>è§£ææ ‘å¯è§†åŒ–</h1>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4682b4;"></div>
                <span>éç»ˆç»“ç¬¦</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ff7f0e;"></div>
                <span>ç»ˆç»“ç¬¦</span>
            </div>
        </div>
        
        <div class="controls">
            <button id="expandAll">å±•å¼€æ‰€æœ‰èŠ‚ç‚¹</button>
            <button id="collapseAll">æŠ˜å æ‰€æœ‰èŠ‚ç‚¹</button>
            <button id="resetZoom">é‡ç½®ç¼©æ”¾</button>
            <button id="autoLayout">è‡ªåŠ¨å¸ƒå±€</button>
            <div style="margin-top: 10px;">
                <label for="nodeDistance">èŠ‚ç‚¹é—´è·: </label>
                <input type="range" id="nodeDistance" min="50" max="200" value="100" style="width: 150px;">
                <span id="distanceValue">200</span>
            </div>
        </div>
        
        <div id="tree-container"></div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <script>
        // åŠ è½½è§£ææ ‘æ•°æ®
        d3.json('parser_tree.json').then(data => {
            // è®¾ç½®ç”»å¸ƒå°ºå¯¸ - å¢åŠ é«˜åº¦å’Œè¾¹è·ä»¥é€‚åº”å¤æ‚æ ‘ç»“æ„
            const width = document.getElementById('tree-container').clientWidth;
            const height = 1500; // å¢åŠ é«˜åº¦ä»¥å®¹çº³æ›´å¤šèŠ‚ç‚¹
            const margin = {top: 40, right: 120, bottom: 40, left: 120}; // å¢åŠ è¾¹è·
            
            // å…¨å±€è®¾ç½®
            let nodeDistance = 100; // å‡å°é»˜è®¤èŠ‚ç‚¹é—´è·
            
            // åˆ›å»ºSVGå®¹å™¨
            const svg = d3.select('#tree-container')
                .append('svg')
                .attr('width', width)
                .attr('height', height)
                .append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`)
                .attr('id', 'main-group');
            
            // æ·»åŠ ç¼©æ”¾åŠŸèƒ½
            const zoom = d3.zoom()
                .scaleExtent([0.1, 3])
                .on('zoom', (event) => {
                    svg.attr('transform', event.transform);
                });
            
            d3.select('#tree-container svg')
                .call(zoom)
                .on('dblclick.zoom', null);
            
            // åˆ›å»ºæ ‘å½¢å¸ƒå±€ - ä½¿ç”¨è‡ªå®šä¹‰èŠ‚ç‚¹é—´è·
            const treeLayout = d3.tree()
                .size([height - margin.top - margin.bottom, width - margin.left - margin.right])
                .separation((a, b) => {
                    // å¢åŠ èŠ‚ç‚¹é—´çš„æ°´å¹³é—´è·ï¼Œç‰¹åˆ«æ˜¯å¯¹äºä¸åŒçˆ¶èŠ‚ç‚¹çš„èŠ‚ç‚¹
                    return (a.parent === b.parent ? 0.8 : 1); // å‡å°èŠ‚ç‚¹é—´çš„å‚ç›´é—´è·ç³»æ•°
                });
            
            // åˆ›å»ºæ ¹èŠ‚ç‚¹
            const root = d3.hierarchy(data);
            
            // åˆå§‹ä½ç½®è®¾ç½®åœ¨å·¦ä¾§ä¸­é—´
            root.x0 = height / 2;
            root.y0 = 0;
            
            // ä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ†é…å”¯ä¸€ID
            let nodeId = 0;
            root.descendants().forEach(d => {
                d.id = nodeId++;
                // åˆå§‹çŠ¶æ€ä¸‹æŠ˜å æ·±åº¦å¤§äº1çš„èŠ‚ç‚¹ï¼Œå‡å°‘åˆå§‹æ˜¾ç¤ºçš„å¤æ‚åº¦
                if (d.depth > 1) {
                    if (d.parent && !d.parent._children) {
                        d.parent._children = [];
                        d.parent.children.forEach(child => {
                            d.parent._children.push(child);
                        });
                        d.parent.children = null;
                    }
                }
            });
            
            // æ›´æ–°æ ‘å½¢å›¾
            update(root);
            
            // å±•å¼€/æŠ˜å æ‰€æœ‰èŠ‚ç‚¹çš„æŒ‰é’®åŠŸèƒ½
            document.getElementById('expandAll').addEventListener('click', () => {
                expandAll(root);
                update(root);
            });
            
            document.getElementById('collapseAll').addEventListener('click', () => {
                root.children.forEach(collapse);
                update(root);
            });
            
            document.getElementById('resetZoom').addEventListener('click', () => {
                d3.select('#tree-container svg')
                    .transition()
                    .duration(750)
                    .call(zoom.transform, d3.zoomIdentity.translate(margin.left, margin.top));
            });
            
            // æ·»åŠ è‡ªåŠ¨å¸ƒå±€åŠŸèƒ½
            document.getElementById('autoLayout').addEventListener('click', () => {
                // è‡ªåŠ¨è°ƒæ•´æ ‘çš„å¤§å°ä»¥é€‚åº”å½“å‰èŠ‚ç‚¹æ•°é‡
                const visibleNodes = root.descendants().filter(d => !d.parent || d.parent.children);
                const newHeight = Math.max(800, visibleNodes.length * 12); // å‡å°æ¯ä¸ªèŠ‚ç‚¹çš„å‚ç›´ç©ºé—´
                
                treeLayout.size([newHeight - margin.top - margin.bottom, width - margin.left - margin.right]);
                update(root);
                
                // è‡ªåŠ¨ç¼©æ”¾ä»¥é€‚åº”æ•´ä¸ªæ ‘
                const svgNode = d3.select('#tree-container svg').node();
                const bounds = document.getElementById('main-group').getBBox();
                const fullWidth = bounds.width;
                const fullHeight = bounds.height;
                
                const scale = 0.9 / Math.max(fullWidth / (width - margin.left - margin.right), 
                                             fullHeight / (height - margin.top - margin.bottom));
                
                const translateX = margin.left + (width - margin.left - margin.right - fullWidth * scale) / 2;
                const translateY = margin.top + (height - margin.top - margin.bottom - fullHeight * scale) / 2;
                
                d3.select('#tree-container svg')
                    .transition()
                    .duration(750)
                    .call(zoom.transform, d3.zoomIdentity.translate(translateX, translateY).scale(scale));
            });
            
            // æ·»åŠ èŠ‚ç‚¹é—´è·è°ƒæ•´åŠŸèƒ½
            const distanceSlider = document.getElementById('nodeDistance');
            const distanceValue = document.getElementById('distanceValue');
            
            distanceSlider.addEventListener('input', function() {
                // æ›´æ–°å…¨å±€èŠ‚ç‚¹é—´è·å˜é‡
                nodeDistance = parseInt(this.value);
                distanceValue.textContent = nodeDistance;
                
                // é‡æ–°æ¸²æŸ“æ ‘
                update(root);
            });
            
            // åˆå§‹åŒ–æ»‘å—å€¼
            distanceSlider.value = nodeDistance;
            distanceValue.textContent = nodeDistance;
            
            // æ›´æ–°æ ‘å½¢å›¾çš„å‡½æ•°
            function update(source) {
                // è®¡ç®—æ–°çš„æ ‘å½¢å¸ƒå±€
                const treeData = treeLayout(root);
                
                // è·å–æ‰€æœ‰èŠ‚ç‚¹å’Œè¿çº¿
                const nodes = treeData.descendants();
                const links = treeData.links();
                
                // è®¾ç½®èŠ‚ç‚¹çš„yåæ ‡ï¼Œä½¿æ ‘å½¢å›¾æ°´å¹³å±•å¼€ - ä½¿ç”¨å…¨å±€èŠ‚ç‚¹é—´è·å˜é‡
                nodes.forEach(d => {
                    d.y = d.depth * nodeDistance; // ä½¿ç”¨å…¨å±€å˜é‡æ§åˆ¶é—´è·
                    // ä¸ºç›¸é‚»èŠ‚ç‚¹æ·»åŠ ä¸€äº›éšæœºåç§»ï¼Œé¿å…æ–‡æœ¬é‡å 
                    if (d.parent && d.parent.children && d.parent.children.length > 1) {
                        const siblings = d.parent.children;
                        const idx = siblings.indexOf(d);
                        if (idx > 0 && Math.abs(d.x - siblings[idx-1].x) < 15) {
                            d.x += 5; // æ·»åŠ å°åç§»
                        }
                    }
                });
                
                // æ›´æ–°èŠ‚ç‚¹
                const node = svg.selectAll('.node')
                    .data(nodes, d => d.id || (d.id = ++nodeId));
                
                // åˆ›å»ºæ–°èŠ‚ç‚¹
                const nodeEnter = node.enter().append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${source.y0},${source.x0})`)
                    .on('click', (event, d) => {
                        // ç‚¹å‡»èŠ‚ç‚¹æ—¶å±•å¼€æˆ–æŠ˜å 
                        if (d.children) {
                            d._children = d.children;
                            d.children = null;
                        } else if (d._children) {
                            d.children = d._children;
                            d._children = null;
                        }
                        update(d);
                    })
                    .on('mouseover', (event, d) => {
                        // æ˜¾ç¤ºèŠ‚ç‚¹è¯¦ç»†ä¿¡æ¯
                        const tooltip = d3.select('#tooltip');
                        let content = '';
                        
                        if (d.data.type === 'terminal') {
                            content = `ç±»å‹: ç»ˆç»“ç¬¦<br>å€¼: "${d.data.value.replace(/ /g, 'ğŸ”¸')}"`;
                        } else {
                            content = `ç±»å‹: éç»ˆç»“ç¬¦<br>å€¼: "${d.data.value}"`;
                        }
                        
                        tooltip.html(content)
                            .style('left', (event.pageX + 10) + 'px')
                            .style('top', (event.pageY - 28) + 'px')
                            .style('opacity', 0.9);
                    })
                    .on('mouseout', () => {
                        // éšè—æç¤ºæ¡†
                        d3.select('#tooltip').style('opacity', 0);
                    });
                
                // æ·»åŠ èŠ‚ç‚¹åœ†åœˆ
                nodeEnter.append('circle')
                    .attr('r', 5) // å‡å°åœ†åœˆå¤§å°
                    .style('fill', d => {
                        // æ ¹æ®èŠ‚ç‚¹ç±»å‹è®¾ç½®ä¸åŒé¢œè‰²
                        if (d.data.type === 'terminal') {
                            return '#ff7f0e'; // ç»ˆç»“ç¬¦ä¸ºæ©™è‰²
                        } else {
                            return '#4682b4'; // éç»ˆç»“ç¬¦ä¸ºè“è‰²
                        }
                    })
                    .style('stroke', d => {
                        return d._children ? '#888' : '#ddd';
                    });
                
                // æ·»åŠ èŠ‚ç‚¹æ–‡æœ¬æ ‡ç­¾
                nodeEnter.append('text')
                    .attr('dy', '.35em')
                    .attr('x', d => d.children || d._children ? -10 : 10) // è°ƒæ•´æ–‡æœ¬ä½ç½®
                    .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
                    .style('font-size', '10px') // å‡å°å­—ä½“å¤§å°
                    .text(d => {
                        // æ˜¾ç¤ºèŠ‚ç‚¹å€¼
                        if (d.data.value) {
                            let displayValue = d.data.value.replace(/ /g, 'ğŸ”¸');
                            return displayValue.length > 15 ? displayValue.substring(0, 15) + '...' : displayValue;
                        }
                        return '';
                    });
                
                // æ›´æ–°ç°æœ‰èŠ‚ç‚¹ä½ç½®
                const nodeUpdate = nodeEnter.merge(node);
                
                nodeUpdate.transition()
                    .duration(750)
                    .attr('transform', d => `translate(${d.y},${d.x})`);
                
                nodeUpdate.select('circle')
                    .attr('r', 5) // å‡å°åœ†åœˆå¤§å°
                    .style('fill', d => {
                        if (d.data.type === 'terminal') {
                            return '#ff7f0e';
                        } else {
                            return '#4682b4';
                        }
                    })
                    .style('stroke', d => d._children ? '#888' : '#ddd');
                
                // ç§»é™¤é€€å‡ºçš„èŠ‚ç‚¹
                const nodeExit = node.exit().transition()
                    .duration(750)
                    .attr('transform', d => `translate(${source.y},${source.x})`)
                    .remove();
                
                nodeExit.select('circle')
                    .attr('r', 0);
                
                nodeExit.select('text')
                    .style('fill-opacity', 0);
                
                // æ›´æ–°è¿çº¿
                const link = svg.selectAll('.link')
                    .data(links, d => d.target.id);
                
                // åˆ›å»ºæ–°è¿çº¿
                const linkEnter = link.enter().insert('path', 'g')
                    .attr('class', 'link')
                    .attr('d', d => {
                        const o = {x: source.x0, y: source.y0};
                        return diagonal(o, o);
                    });
                
                // æ›´æ–°ç°æœ‰è¿çº¿
                linkEnter.merge(link).transition()
                    .duration(750)
                    .attr('d', d => diagonal(d.source, d.target));
                
                // ç§»é™¤é€€å‡ºçš„è¿çº¿
                link.exit().transition()
                    .duration(750)
                    .attr('d', d => {
                        const o = {x: source.x, y: source.y};
                        return diagonal(o, o);
                    })
                    .remove();
                
                // ä¿å­˜æ—§ä½ç½®ç”¨äºè¿‡æ¸¡åŠ¨ç”»
                nodes.forEach(d => {
                    d.x0 = d.x;
                    d.y0 = d.y;
                });
            }
            
            // åˆ›å»ºæ›²çº¿è¿çº¿
            function diagonal(s, d) {
                return `M ${s.y} ${s.x}
                        C ${(s.y + d.y) / 2} ${s.x},
                          ${(s.y + d.y) / 2} ${d.x},
                          ${d.y} ${d.x}`;
            }
            
            // æŠ˜å èŠ‚ç‚¹åŠå…¶å­èŠ‚ç‚¹
            function collapse(d) {
                if (d.children) {
                    d._children = d.children;
                    d._children.forEach(collapse);
                    d.children = null;
                }
            }
            
            // å±•å¼€æ‰€æœ‰èŠ‚ç‚¹
            function expandAll(d) {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
                if (d.children) {
                    d.children.forEach(expandAll);
                }
            }
        }).catch(error => {
            console.error('åŠ è½½æ•°æ®å‡ºé”™:', error);
            document.getElementById('tree-container').innerHTML = 
                '<div style="color: red; text-align: center; margin-top: 50px;">' +
                '<h3>åŠ è½½æ•°æ®å‡ºé”™</h3>' +
                '<p>è¯·ç¡®ä¿ parser_tree.json æ–‡ä»¶å­˜åœ¨ä¸”æ ¼å¼æ­£ç¡®</p>' +
                '<p>é”™è¯¯è¯¦æƒ…: ' + error.message + '</p>' +
                '</div>';
        });
    </script>
</body>
</html>